"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.FinicityConnect = void 0;

require("core-js/stable/url");

var _constants = require("./constants");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var evHandlers;
var onMessageFn;
var connectUrl;
var iframe;
var metaEl;
var targetWindow;
var connectOrigin;
var popupWindow;
var defaultEventHandlers = {
  onLoad: function onLoad() {},
  onUser: function onUser(event) {},
  onRoute: function onRoute(event) {}
};
var defaultPopupOptions = {
  toolbar: 'no',
  location: 'no',
  status: 'no',
  menubar: 'no',
  width: _constants.CONNECT_POPUP_HEIGHT,
  height: _constants.CONNECT_POPUP_WIDTH,
  top: window.self.outerHeight / 2 + window.self.screenY - _constants.CONNECT_POPUP_HEIGHT / 2,
  left: window.self.outerWidth / 2 + window.self.screenX - _constants.CONNECT_POPUP_WIDTH / 2
};
var FinicityConnect = {
  destroy: function destroy() {
    if (iframe && iframe.parentNode) {
      iframe.parentNode.removeChild(iframe);
    }

    if (metaEl && metaEl.parentNode) {
      metaEl.parentNode.removeChild(metaEl);
    }

    if (!iframe && targetWindow) {
      targetWindow.close();
    }

    iframe = undefined;
    metaEl = undefined;
    window.removeEventListener('message', onMessageFn);
  },
  launch: function launch(url, eventHandlers) {
    var _this = this;

    var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};
    connectUrl = url;
    evHandlers = _objectSpread(_objectSpread({}, defaultEventHandlers), eventHandlers);
    connectOrigin = new URL(connectUrl).origin;

    if (options.popup) {
      var popupOptions = _objectSpread(_objectSpread({}, defaultPopupOptions), options.popupOptions);

      var _popupWindow = window.open(connectUrl, 'targetWindow', "toolbar=".concat(defaultPopupOptions.toolbar, ",location=").concat(defaultPopupOptions.location, ",status=").concat(defaultPopupOptions.status, ",menubar=").concat(defaultPopupOptions.menubar, ",width=").concat(popupOptions.width, ",height=").concat(popupOptions.height, ",top=").concat(popupOptions.top, ",left=").concat(popupOptions.left));

      if (!_popupWindow) {
        evHandlers.onError({
          reason: 'error',
          code: 1403
        });
      } else {
        targetWindow = _popupWindow;

        _popupWindow.focus();

        this.initPostMessage(options);
        evHandlers.onLoad && evHandlers.onLoad();
      }

      return _popupWindow;
    } else {
      if (iframe && iframe.parentNode) {
        throw new Error('You must destroy the iframe before you can open a new one. Call "destroy()"');
      }

      var metaArray = document.querySelectorAll('meta[name="viewport"]');

      if (metaArray.length === 0) {
        metaEl = document.createElement('meta');
        metaEl.setAttribute('name', 'viewport');
        metaEl.setAttribute('content', 'initial-scale=1');
        document.head.appendChild(metaEl);
      }

      iframe = document.createElement('iframe');
      iframe.src = connectUrl;
      iframe.setAttribute('id', _constants.IFRAME_ID);
      iframe.setAttribute('frameborder', '0');
      iframe.setAttribute('scrolling', 'no'); // NOTE: update overlay

      if (options.overlay) {
        iframe.setAttribute('style', "background: ".concat(options.overlay, ";"));
      }

      if (options.node) {
        options.node.appendChild(iframe);
      } else {
        // NOTE: attach to selector if specified
        var parentEl = !!options.selector ? document.querySelector(options.selector) : document.body;

        if (parentEl) {
          parentEl.appendChild(iframe);
        } else {
          console.warn("Couldn't find any elements matching \"".concat(options.selector, "\", appending \"iframe\" to \"body\" instead."));
          document.body.appendChild(iframe);
        }
      }

      iframe.onload = function () {
        targetWindow = iframe.contentWindow;

        _this.initPostMessage(options);

        evHandlers.onLoad && evHandlers.onLoad();
      };

      return null;
    }
  },
  initPostMessage: function initPostMessage(options) {
    var _this2 = this;

    // NOTE: ping connect until it responds
    var intervalId = setInterval(function () {
      return _this2.postMessage({
        type: _constants.PING_EVENT,
        selector: options.selector,
        sdkVersion: _constants.CONNECT_SDK_VERSION,
        platform: "".concat(options.popup ? _constants.PLATFORM_POPUP : _constants.PLATFORM_IFRAME)
      });
    }, 1000);

    onMessageFn = function onMessageFn(event) {
      var payload = event.data.data;
      var eventType = event.data.type; // NOTE: make sure it's Connect and not a bad actor

      if (event.origin === connectOrigin) {
        // NOTE: actively pinging connect while it's displayed in a popup allows us to recover the
        // session if the user refreshes the popup
        if (eventType === _constants.ACK_EVENT && !options.popup) {
          clearInterval(intervalId);
        } else if (eventType === _constants.URL_EVENT) {
          _this2.openPopupWindow(event.data.url);
        } else if (eventType === _constants.DONE_EVENT) {
          evHandlers.onDone(payload);

          _this2.destroy();
        } else if (eventType === _constants.CANCEL_EVENT) {
          evHandlers.onCancel(payload);

          _this2.destroy();
        } else if (eventType === _constants.ERROR_EVENT) {
          evHandlers.onError(payload);

          _this2.destroy();
        } else if (eventType === _constants.ROUTE_EVENT) {
          evHandlers.onRoute && evHandlers.onRoute(payload);
        } else if (eventType === _constants.USER_EVENT) {
          evHandlers.onUser && evHandlers.onUser(payload);
        } else if (eventType === _constants.CLOSE_POPUP_EVENT) {
          var _popupWindow2;

          (_popupWindow2 = popupWindow) === null || _popupWindow2 === void 0 ? void 0 : _popupWindow2.close();
        }
      }
    };

    window.addEventListener('message', onMessageFn);
  },
  openPopupWindow: function openPopupWindow(url) {
    var _this3 = this;

    var top = window.self.outerHeight / 2 + window.self.screenY - _constants.POPUP_HEIGHT / 2;
    var left = window.self.outerWidth / 2 + window.self.screenX - _constants.POPUP_WIDTH / 2;
    popupWindow = window.open(url, 'targetWindow', "toolbar=no,location=no,status=no,menubar=no,width=".concat(_constants.POPUP_WIDTH, ",height=").concat(_constants.POPUP_HEIGHT, ",top=").concat(top, ",left=").concat(left));

    if (popupWindow) {
      popupWindow.focus();
      var intervalId = setInterval(function () {
        var _popupWindow3;

        // clear itself if window no longer exists or has been closed
        if ((_popupWindow3 = popupWindow) !== null && _popupWindow3 !== void 0 && _popupWindow3.closed) {
          // window closed, notify connect
          clearInterval(intervalId);

          _this3.postMessage({
            type: _constants.WINDOW_EVENT,
            closed: true,
            blocked: false
          });
        }
      }, 1000);
    } else {
      this.postMessage({
        type: _constants.WINDOW_EVENT,
        closed: true,
        blocked: true
      });
    }
  },
  postMessage: function postMessage(data) {
    var _targetWindow;

    (_targetWindow = targetWindow) === null || _targetWindow === void 0 ? void 0 : _targetWindow.postMessage(data, connectUrl);
  }
};
exports.FinicityConnect = FinicityConnect;

(function applyStyles() {
  if (!document.getElementById(_constants.STYLES_ID)) {
    var style = document.createElement('style');
    style.id = _constants.STYLES_ID;
    style.type = 'text/css';
    style.innerHTML = "#".concat(_constants.IFRAME_ID, " {\n      position: absolute;\n      left: 0;\n      top: 0;\n      width: 100%;\n      height: 100%;\n      z-index: 10;\n      background: rgba(0,0,0,0.8);\n    }");
    document.getElementsByTagName('head')[0].appendChild(style);
  }
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC50cyJdLCJuYW1lcyI6WyJldkhhbmRsZXJzIiwib25NZXNzYWdlRm4iLCJjb25uZWN0VXJsIiwiaWZyYW1lIiwibWV0YUVsIiwidGFyZ2V0V2luZG93IiwiY29ubmVjdE9yaWdpbiIsInBvcHVwV2luZG93IiwiZGVmYXVsdEV2ZW50SGFuZGxlcnMiLCJvbkxvYWQiLCJvblVzZXIiLCJldmVudCIsIm9uUm91dGUiLCJkZWZhdWx0UG9wdXBPcHRpb25zIiwidG9vbGJhciIsImxvY2F0aW9uIiwic3RhdHVzIiwibWVudWJhciIsIndpZHRoIiwiQ09OTkVDVF9QT1BVUF9IRUlHSFQiLCJoZWlnaHQiLCJDT05ORUNUX1BPUFVQX1dJRFRIIiwidG9wIiwid2luZG93Iiwic2VsZiIsIm91dGVySGVpZ2h0Iiwic2NyZWVuWSIsImxlZnQiLCJvdXRlcldpZHRoIiwic2NyZWVuWCIsIkZpbmljaXR5Q29ubmVjdCIsImRlc3Ryb3kiLCJwYXJlbnROb2RlIiwicmVtb3ZlQ2hpbGQiLCJjbG9zZSIsInVuZGVmaW5lZCIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJsYXVuY2giLCJ1cmwiLCJldmVudEhhbmRsZXJzIiwib3B0aW9ucyIsIlVSTCIsIm9yaWdpbiIsInBvcHVwIiwicG9wdXBPcHRpb25zIiwib3BlbiIsIm9uRXJyb3IiLCJyZWFzb24iLCJjb2RlIiwiZm9jdXMiLCJpbml0UG9zdE1lc3NhZ2UiLCJFcnJvciIsIm1ldGFBcnJheSIsImRvY3VtZW50IiwicXVlcnlTZWxlY3RvckFsbCIsImxlbmd0aCIsImNyZWF0ZUVsZW1lbnQiLCJzZXRBdHRyaWJ1dGUiLCJoZWFkIiwiYXBwZW5kQ2hpbGQiLCJzcmMiLCJJRlJBTUVfSUQiLCJvdmVybGF5Iiwibm9kZSIsInBhcmVudEVsIiwic2VsZWN0b3IiLCJxdWVyeVNlbGVjdG9yIiwiYm9keSIsImNvbnNvbGUiLCJ3YXJuIiwib25sb2FkIiwiY29udGVudFdpbmRvdyIsImludGVydmFsSWQiLCJzZXRJbnRlcnZhbCIsInBvc3RNZXNzYWdlIiwidHlwZSIsIlBJTkdfRVZFTlQiLCJzZGtWZXJzaW9uIiwiQ09OTkVDVF9TREtfVkVSU0lPTiIsInBsYXRmb3JtIiwiUExBVEZPUk1fUE9QVVAiLCJQTEFURk9STV9JRlJBTUUiLCJwYXlsb2FkIiwiZGF0YSIsImV2ZW50VHlwZSIsIkFDS19FVkVOVCIsImNsZWFySW50ZXJ2YWwiLCJVUkxfRVZFTlQiLCJvcGVuUG9wdXBXaW5kb3ciLCJET05FX0VWRU5UIiwib25Eb25lIiwiQ0FOQ0VMX0VWRU5UIiwib25DYW5jZWwiLCJFUlJPUl9FVkVOVCIsIlJPVVRFX0VWRU5UIiwiVVNFUl9FVkVOVCIsIkNMT1NFX1BPUFVQX0VWRU5UIiwiYWRkRXZlbnRMaXN0ZW5lciIsIlBPUFVQX0hFSUdIVCIsIlBPUFVQX1dJRFRIIiwiY2xvc2VkIiwiV0lORE9XX0VWRU5UIiwiYmxvY2tlZCIsImFwcGx5U3R5bGVzIiwiZ2V0RWxlbWVudEJ5SWQiLCJTVFlMRVNfSUQiLCJzdHlsZSIsImlkIiwiaW5uZXJIVE1MIiwiZ2V0RWxlbWVudHNCeVRhZ05hbWUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFFQTs7Ozs7Ozs7QUFzQkEsSUFBSUEsVUFBSjtBQUNBLElBQUlDLFdBQUo7QUFDQSxJQUFJQyxVQUFKO0FBQ0EsSUFBSUMsTUFBSjtBQUNBLElBQUlDLE1BQUo7QUFDQSxJQUFJQyxZQUFKO0FBQ0EsSUFBSUMsYUFBSjtBQUNBLElBQUlDLFdBQUo7QUFXQSxJQUFNQyxvQkFBeUIsR0FBRztBQUNoQ0MsRUFBQUEsTUFBTSxFQUFFLGtCQUFNLENBQUUsQ0FEZ0I7QUFFaENDLEVBQUFBLE1BQU0sRUFBRSxnQkFBQ0MsS0FBRCxFQUFnQixDQUFFLENBRk07QUFHaENDLEVBQUFBLE9BQU8sRUFBRSxpQkFBQ0QsS0FBRCxFQUE4QixDQUFFO0FBSFQsQ0FBbEM7QUFzREEsSUFBTUUsbUJBQW1CLEdBQUc7QUFDMUJDLEVBQUFBLE9BQU8sRUFBRSxJQURpQjtBQUUxQkMsRUFBQUEsUUFB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Q0EsVUFBQSxNQUFJLENBQUNFLFdBQUwsQ0FBaUI7QUFDZkMsWUFBQUEsSUFBSSxFQUFFMEIsdUJBRFM7QUFFZkQsWUFBQUEsTUFBTSxFQUFFLElBRk87QUFHZkUsWUFBQUEsT0FBTyxFQUFFO0FBSE0sV0FBakI7QUFLRDtBQUNGLE9BWDZCLEVBVzNCLElBWDJCLENBQTlCO0FBWUQsS0FkRCxNQWNPO0FBQ0wsV0FBSzVCLFdBQUwsQ0FBaUI7QUFDZkMsUUFBQUEsSUFBSSxFQUFFMEIsdUJBRFM7QUFFZkQsUUFBQUEsTUFBTSxFQUFFLElBRk87QUFHZkUsUUFBQUEsT0FBTyxFQUFFO0FBSE0sT0FBakI7QUFLRDtBQUNGLEdBbkw2QztBQXFMOUM1QixFQUFBQSxXQXJMOEMsdUJBcUxsQ1MsSUFyTGtDLEVBcUx2QjtBQUFBOztBQUNyQixxQkFBQTlFLFlBQVksVUFBWixzREFBY3FFLFdBQWQsQ0FBMEJTLElBQTFCLEVBQWdDakYsVUFBaEM7QUFDRDtBQXZMNkMsQ0FBekM7OztBQTBMUCxDQUFDLFNBQVNxRyxXQUFULEdBQXVCO0FBQ3RCLE1BQUksQ0FBQ2xELFFBQVEsQ0FBQ21ELGNBQVQsQ0FBd0JDLG9CQUF4QixDQUFMLEVBQXlDO0FBQ3ZDLFFBQU1DLEtBQUssR0FBR3JELFFBQVEsQ0FBQ0csYUFBVCxDQUF1QixPQUF2QixDQUFkO0FBQ0FrRCxJQUFBQSxLQUFLLENBQUNDLEVBQU4sR0FBV0Ysb0JBQVg7QUFDQUMsSUFBQUEsS0FBSyxDQUFDL0IsSUFBTixHQUFhLFVBQWI7QUFDQStCLElBQUFBLEtBQUssQ0FBQ0UsU0FBTixjQUFzQi9DLG9CQUF0QjtBQVNBUixJQUFBQSxRQUFRLENBQUN3RCxvQkFBVCxDQUE4QixNQUE5QixFQUFzQyxDQUF0QyxFQUF5Q2xELFdBQXpDLENBQXFEK0MsS0FBckQ7QUFDRDtBQUNGLENBaEJEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICdjb3JlLWpzL3N0YWJsZS91cmwnO1xuXG5pbXBvcnQge1xuICBJRlJBTUVfSUQsXG4gIFBPUFVQX1dJRFRILFxuICBQT1BVUF9IRUlHSFQsXG4gIENPTk5FQ1RfUE9QVVBfSEVJR0hULFxuICBDT05ORUNUX1BPUFVQX1dJRFRILFxuICBBQ0tfRVZFTlQsXG4gIENBTkNFTF9FVkVOVCxcbiAgVVJMX0VWRU5ULFxuICBET05FX0VWRU5ULFxuICBFUlJPUl9FVkVOVCxcbiAgUElOR19FVkVOVCxcbiAgV0lORE9XX0VWRU5ULFxuICBST1VURV9FVkVOVCxcbiAgVVNFUl9FVkVOVCxcbiAgU1RZTEVTX0lELFxuICBDT05ORUNUX1NES19WRVJTSU9OLFxuICBDTE9TRV9QT1BVUF9FVkVOVCxcbiAgUExBVEZPUk1fUE9QVVAsXG4gIFBMQVRGT1JNX0lGUkFNRSxcbn0gZnJvbSAnLi9jb25zdGFudHMnO1xuXG5sZXQgZXZIYW5kbGVyczogQ29ubmVjdEV2ZW50SGFuZGxlcnM7XG5sZXQgb25NZXNzYWdlRm46IGFueTtcbmxldCBjb25uZWN0VXJsOiBzdHJpbmc7XG5sZXQgaWZyYW1lOiBhbnk7XG5sZXQgbWV0YUVsOiBhbnk7XG5sZXQgdGFyZ2V0V2luZG93OiBXaW5kb3c7XG5sZXQgY29ubmVjdE9yaWdpbjogc3RyaW5nO1xubGV0IHBvcHVwV2luZG93OiBXaW5kb3cgfCBudWxsO1xuXG5leHBvcnQgaW50ZXJmYWNlIENvbm5lY3RFdmVudEhhbmRsZXJzIHtcbiAgb25Eb25lOiAoZXZlbnQ6IENvbm5lY3REb25lRXZlbnQpID0+IHZvaWQ7XG4gIG9uQ2FuY2VsOiAoZXZlbnQ6IENvbm5lY3RDYW5jZWxFdmVudCkgPT4gdm9pZDtcbiAgb25FcnJvcjogKGV2ZW50OiBDb25uZWN0RXJyb3JFdmVudCkgPT4gdm9pZDtcbiAgb25Sb3V0ZT86IChldmVudDogQ29ubmVjdFJvdXRlRXZlbnQpID0+IHZvaWQ7XG4gIG9uVXNlcj86IChldmVudDogYW55KSA9PiB2b2lkO1xuICBvbkxvYWQ/OiAoKSA9PiB2b2lkO1xufVxuXG5jb25zdCBkZWZhdWx0RXZlbnRIYW5kbGVyczogYW55ID0ge1xuICBvbkxvYWQ6ICgpID0+IHt9LFxuICBvblVzZXI6IChldmVudDogYW55KSA9PiB7fSxcbiAgb25Sb3V0ZTogKGV2ZW50OiBDb25uZWN0Um91dGVFdmVudCkgPT4ge30sXG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIEZpbmljaXR5Q29ubmVjdFByb3BzIHtcbiAgY29ubmVjdFVybDogc3RyaW5nO1xuICBldmVudEhhbmRsZXJzOiBDb25uZWN0RXZlbnRIYW5kbGVycztcbiAgbGlua2luZ1VyaT86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb25uZWN0Q2FuY2VsRXZlbnQge1xuICBjb2RlOiBudW1iZXI7XG4gIHJlYXNvbjogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENvbm5lY3RFcnJvckV2ZW50IHtcbiAgY29kZTogbnVtYmVyO1xuICByZWFzb246IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb25uZWN0RG9uZUV2ZW50IHtcbiAgY29kZTogbnVtYmVyO1xuICByZWFzb246IHN0cmluZztcbiAgcmVwb3J0RGF0YTogW1xuICAgIHtcbiAgICAgIHBvcnRmb2xpb0lkOiBzdHJpbmc7XG4gICAgICB0eXBlOiBzdHJpbmc7XG4gICAgICByZXBvcnRJZDogc3RyaW5nO1xuICAgIH1cbiAgXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb25uZWN0Um91dGVFdmVudCB7XG4gIHNjcmVlbjogc3RyaW5nO1xuICBwYXJhbXM6IGFueTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb25uZWN0T3B0aW9ucyB7XG4gIHNlbGVjdG9yPzogc3RyaW5nO1xuICBub2RlPzogTm9kZTtcbiAgb3ZlcmxheT86IHN0cmluZztcbiAgcG9wdXA/OiBib29sZWFuO1xuICBwb3B1cE9wdGlvbnM/OiBQb3B1cE9wdGlvbnM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUG9wdXBPcHRpb25zIHtcbiAgd2lkdGg/OiBudW1iZXI7XG4gIGhlaWdodD86IG51bWJlcjtcbiAgdG9wPzogbnVtYmVyO1xuICBsZWZ0PzogbnVtYmVyO1xufVxuXG5jb25zdCBkZWZhdWx0UG9wdXBPcHRpb25zID0ge1xuICB0b29sYmFyOiAnbm8nLFxuICBsb2NhdGlvbjogJ25vJyxcbiAgc3RhdHVzOiAnbm8nLFxuICBtZW51YmFyOiAnbm8nLFxuICB3aWR0aDogQ09OTkVDVF9QT1BVUF9IRUlHSFQsXG4gIGhlaWdodDogQ09OTkVDVF9QT1BVUF9XSURUSCxcbiAgdG9wOlxuICAgIHdpbmRvdy5zZWxmLm91dGVySGVpZ2h0IC8gMiArXG4gICAgd2luZG93LnNlbGYuc2NyZWVuWSAtXG4gICAgQ09OTkVDVF9QT1BVUF9IRUlHSFQgLyAyLFxuICBsZWZ0OlxuICAgIHdpbmRvdy5zZWxmLm91dGVyV2lkdGggLyAyICsgd2luZG93LnNlbGYuc2NyZWVuWCAtIENPTk5FQ1RfUE9QVVBfV0lEVEggLyAyLFxufTtcblxuaW50ZXJmYWNlIEZpbmljaXR5Q29ubmVjdCB7XG4gIGRlc3Ryb3k6ICgpID0+IHZvaWQ7XG4gIGxhdW5jaDogKFxuICAgIHVybDogc3RyaW5nLFxuICAgIGV2ZW50SGFuZGxlcnM6IENvbm5lY3RFdmVudEhhbmRsZXJzLFxuICAgIG9wdGlvbnM/OiBDb25uZWN0T3B0aW9uc1xuICApID0+IFdpbmRvdyB8IG51bGwgfCB2b2lkO1xuICBpbml0UG9zdE1lc3NhZ2U6IChvcHRpb25zOiBDb25uZWN0T3B0aW9ucykgPT4gdm9pZDtcbiAgb3BlblBvcHVwV2luZG93OiAodXJsOiBzdHJpbmcpID0+IHZvaWQ7XG4gIHBvc3RNZXNzYWdlOiAoZXZlbnQ6IGFueSkgPT4gdm9pZDtcbn1cblxuZXhwb3J0IGNvbnN0IEZpbmljaXR5Q29ubmVjdDogRmluaWNpdHlDb25uZWN0ID0ge1xuICBkZXN0cm95KCkge1xuICAgIGlmIChpZnJhbWUgJiYgaWZyYW1lLnBhcmVudE5vZGUpIHtcbiAgICAgIGlmcmFtZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGlmcmFtZSk7XG4gICAgfVxuXG4gICAgaWYgKG1ldGFFbCAmJiBtZXRhRWwucGFyZW50Tm9kZSkge1xuICAgICAgbWV0YUVsLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobWV0YUVsKTtcbiAgICB9XG5cbiAgICBpZiAoIWlmcmFtZSAmJiB0YXJnZXRXaW5kb3cpIHtcbiAgICAgIHRhcmdldFdpbmRvdy5jbG9zZSgpO1xuICAgIH1cblxuICAgIGlmcmFtZSA9IHVuZGVmaW5lZDtcbiAgICBtZXRhRWwgPSB1bmRlZmluZWQ7XG5cbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIG9uTWVzc2FnZUZuKTtcbiAgfSxcblxuICBsYXVuY2goXG4gICAgdXJsOiBzdHJpbmcsXG4gICAgZXZlbnRIYW5kbGVyczogQ29ubmVjdEV2ZW50SGFuZGxlcnMsXG4gICAgb3B0aW9uczogQ29ubmVjdE9wdGlvbnMgPSB7fVxuICApIHtcbiAgICBjb25uZWN0VXJsID0gdXJsO1xuICAgIGV2SGFuZGxlcnMgPSB7IC4uLmRlZmF1bHRFdmVudEhhbmRsZXJzLCAuLi5ldmVudEhhbmRsZXJzIH07XG4gICAgY29ubmVjdE9yaWdpbiA9IG5ldyBVUkwoY29ubmVjdFVybCkub3JpZ2luO1xuXG4gICAgaWYgKG9wdGlvbnMucG9wdXApIHtcbiAgICAgIGNvbnN0IHBvcHVwT3B0aW9ucyA9IHsgLi4uZGVmYXVsdFBvcHVwT3B0aW9ucywgLi4ub3B0aW9ucy5wb3B1cE9wdGlvbnMgfTtcbiAgICAgIGNvbnN0IHBvcHVwV2luZG93ID0gd2luZG93Lm9wZW4oXG4gICAgICAgIGNvbm5lY3RVcmwsXG4gICAgICAgICd0YXJnZXRXaW5kb3cnLFxuICAgICAgICBgdG9vbGJhcj0ke2RlZmF1bHRQb3B1cE9wdGlvbnMudG9vbGJhcn0sbG9jYXRpb249JHtkZWZhdWx0UG9wdXBPcHRpb25zLmxvY2F0aW9ufSxzdGF0dXM9JHtkZWZhdWx0UG9wdXBPcHRpb25zLnN0YXR1c30sbWVudWJhcj0ke2RlZmF1bHRQb3B1cE9wdGlvbnMubWVudWJhcn0sd2lkdGg9JHtwb3B1cE9wdGlvbnMud2lkdGh9LGhlaWdodD0ke3BvcHVwT3B0aW9ucy5oZWlnaHR9LHRvcD0ke3BvcHVwT3B0aW9ucy50b3B9LGxlZnQ9JHtwb3B1cE9wdGlvbnMubGVmdH1gXG4gICAgICApO1xuXG4gICAgICBpZiAoIXBvcHVwV2luZG93KSB7XG4gICAgICAgIGV2SGFuZGxlcnMub25FcnJvcih7IHJlYXNvbjogJ2Vycm9yJywgY29kZTogMTQwMyB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRhcmdldFdpbmRvdyA9IHBvcHVwV2luZG93O1xuICAgICAgICBwb3B1cFdpbmRvdy5mb2N1cygpO1xuICAgICAgICB0aGlzLmluaXRQb3N0TWVzc2FnZShvcHRpb25zKTtcbiAgICAgICAgZXZIYW5kbGVycy5vbkxvYWQgJiYgZXZIYW5kbGVycy5vbkxvYWQoKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHBvcHVwV2luZG93O1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoaWZyYW1lICYmIGlmcmFtZS5wYXJlbnROb2RlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAnWW91IG11c3QgZGVzdHJveSB0aGUgaWZyYW1lIGJlZm9yZSB5b3UgY2FuIG9wZW4gYSBuZXcgb25lLiBDYWxsIFwiZGVzdHJveSgpXCInXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGxldCBtZXRhQXJyYXkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdtZXRhW25hbWU9XCJ2aWV3cG9ydFwiXScpO1xuICAgICAgaWYgKG1ldGFBcnJheS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgbWV0YUVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbWV0YScpO1xuICAgICAgICBtZXRhRWwuc2V0QXR0cmlidXRlKCduYW1lJywgJ3ZpZXdwb3J0Jyk7XG4gICAgICAgIG1ldGFFbC5zZXRBdHRyaWJ1dGUoJ2NvbnRlbnQnLCAnaW5pdGlhbC1zY2FsZT0xJyk7XG4gICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQobWV0YUVsKTtcbiAgICAgIH1cblxuICAgICAgaWZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7XG5cbiAgICAgIGlmcmFtZS5zcmMgPSBjb25uZWN0VXJsO1xuICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgnaWQnLCBJRlJBTUVfSUQpO1xuICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgnZnJhbWVib3JkZXInLCAnMCcpO1xuICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgnc2Nyb2xsaW5nJywgJ25vJyk7XG5cbiAgICAgIC8vIE5PVEU6IHVwZGF0ZSBvdmVybGF5XG4gICAgICBpZiAob3B0aW9ucy5vdmVybGF5KSB7XG4gICAgICAgIGlmcmFtZS5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgYGJhY2tncm91bmQ6ICR7b3B0aW9ucy5vdmVybGF5fTtgKTtcbiAgICAgIH1cblxuICAgICAgaWYgKG9wdGlvbnMubm9kZSkge1xuICAgICAgICBvcHRpb25zLm5vZGUuYXBwZW5kQ2hpbGQoaWZyYW1lKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIE5PVEU6IGF0dGFjaCB0byBzZWxlY3RvciBpZiBzcGVjaWZpZWRcbiAgICAgICAgY29uc3QgcGFyZW50RWwgPSAhIW9wdGlvbnMuc2VsZWN0b3JcbiAgICAgICAgICA/IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Iob3B0aW9ucy5zZWxlY3RvcilcbiAgICAgICAgICA6IGRvY3VtZW50LmJvZHk7XG4gICAgICAgIGlmIChwYXJlbnRFbCkge1xuICAgICAgICAgIHBhcmVudEVsLmFwcGVuZENoaWxkKGlmcmFtZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgICAgYENvdWxkbid0IGZpbmQgYW55IGVsZW1lbnRzIG1hdGNoaW5nIFwiJHtvcHRpb25zLnNlbGVjdG9yfVwiLCBhcHBlbmRpbmcgXCJpZnJhbWVcIiB0byBcImJvZHlcIiBpbnN0ZWFkLmBcbiAgICAgICAgICApO1xuICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoaWZyYW1lKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZnJhbWUub25sb2FkID0gKCkgPT4ge1xuICAgICAgICB0YXJnZXRXaW5kb3cgPSBpZnJhbWUuY29udGVudFdpbmRvdztcbiAgICAgICAgdGhpcy5pbml0UG9zdE1lc3NhZ2Uob3B0aW9ucyk7XG4gICAgICAgIGV2SGFuZGxlcnMub25Mb2FkICYmIGV2SGFuZGxlcnMub25Mb2FkKCk7XG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH0sXG5cbiAgaW5pdFBvc3RNZXNzYWdlKG9wdGlvbnM6IENvbm5lY3RPcHRpb25zKSB7XG4gICAgLy8gTk9URTogcGluZyBjb25uZWN0IHVudGlsIGl0IHJlc3BvbmRzXG4gICAgY29uc3QgaW50ZXJ2YWxJZCA9IHNldEludGVydmFsKFxuICAgICAgKCkgPT5cbiAgICAgICAgdGhpcy5wb3N0TWVzc2FnZSh7XG4gICAgICAgICAgdHlwZTogUElOR19FVkVOVCxcbiAgICAgICAgICBzZWxlY3Rvcjogb3B0aW9ucy5zZWxlY3RvcixcbiAgICAgICAgICBzZGtWZXJzaW9uOiBDT05ORUNUX1NES19WRVJTSU9OLFxuICAgICAgICAgIHBsYXRmb3JtOiBgJHtvcHRpb25zLnBvcHVwID8gUExBVEZPUk1fUE9QVVAgOiBQTEFURk9STV9JRlJBTUV9YCxcbiAgICAgICAgfSksXG4gICAgICAxMDAwXG4gICAgKTtcblxuICAgIG9uTWVzc2FnZUZuID0gKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSBldmVudC5kYXRhLmRhdGE7XG4gICAgICBjb25zdCBldmVudFR5cGUgPSBldmVudC5kYXRhLnR5cGU7XG4gICAgICAvLyBOT1RFOiBtYWtlIHN1cmUgaXQncyBDb25uZWN0IGFuZCBub3QgYSBiYWQgYWN0b3JcbiAgICAgIGlmIChldmVudC5vcmlnaW4gPT09IGNvbm5lY3RPcmlnaW4pIHtcbiAgICAgICAgLy8gTk9URTogYWN0aXZlbHkgcGluZ2luZyBjb25uZWN0IHdoaWxlIGl0J3MgZGlzcGxheWVkIGluIGEgcG9wdXAgYWxsb3dzIHVzIHRvIHJlY292ZXIgdGhlXG4gICAgICAgIC8vIHNlc3Npb24gaWYgdGhlIHVzZXIgcmVmcmVzaGVzIHRoZSBwb3B1cFxuICAgICAgICBpZiAoZXZlbnRUeXBlID09PSBBQ0tfRVZFTlQgJiYgIW9wdGlvbnMucG9wdXApIHtcbiAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsSWQpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50VHlwZSA9PT0gVVJMX0VWRU5UKSB7XG4gICAgICAgICAgdGhpcy5vcGVuUG9wdXBXaW5kb3coZXZlbnQuZGF0YS51cmwpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50VHlwZSA9PT0gRE9ORV9FVkVOVCkge1xuICAgICAgICAgIGV2SGFuZGxlcnMub25Eb25lKHBheWxvYWQpO1xuICAgICAgICAgIHRoaXMuZGVzdHJveSgpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50VHlwZSA9PT0gQ0FOQ0VMX0VWRU5UKSB7XG4gICAgICAgICAgZXZIYW5kbGVycy5vbkNhbmNlbChwYXlsb2FkKTtcbiAgICAgICAgICB0aGlzLmRlc3Ryb3koKTtcbiAgICAgICAgfSBlbHNlIGlmIChldmVudFR5cGUgPT09IEVSUk9SX0VWRU5UKSB7XG4gICAgICAgICAgZXZIYW5kbGVycy5vbkVycm9yKHBheWxvYWQpO1xuICAgICAgICAgIHRoaXMuZGVzdHJveSgpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50VHlwZSA9PT0gUk9VVEVfRVZFTlQpIHtcbiAgICAgICAgICBldkhhbmRsZXJzLm9uUm91dGUgJiYgZXZIYW5kbGVycy5vblJvdXRlKHBheWxvYWQpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50VHlwZSA9PT0gVVNFUl9FVkVOVCkge1xuICAgICAgICAgIGV2SGFuZGxlcnMub25Vc2VyICYmIGV2SGFuZGxlcnMub25Vc2VyKHBheWxvYWQpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50VHlwZSA9PT0gQ0xPU0VfUE9QVVBfRVZFTlQpIHtcbiAgICAgICAgICBwb3B1cFdpbmRvdz8uY2xvc2UoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG5cbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIG9uTWVzc2FnZUZuKTtcbiAgfSxcblxuICBvcGVuUG9wdXBXaW5kb3codXJsOiBzdHJpbmcpIHtcbiAgICBjb25zdCB0b3AgPVxuICAgICAgd2luZG93LnNlbGYub3V0ZXJIZWlnaHQgLyAyICsgd2luZG93LnNlbGYuc2NyZWVuWSAtIFBPUFVQX0hFSUdIVCAvIDI7XG4gICAgY29uc3QgbGVmdCA9XG4gICAgICB3aW5kb3cuc2VsZi5vdXRlcldpZHRoIC8gMiArIHdpbmRvdy5zZWxmLnNjcmVlblggLSBQT1BVUF9XSURUSCAvIDI7XG4gICAgcG9wdXBXaW5kb3cgPSB3aW5kb3cub3BlbihcbiAgICAgIHVybCxcbiAgICAgICd0YXJnZXRXaW5kb3cnLFxuICAgICAgYHRvb2xiYXI9bm8sbG9jYXRpb249bm8sc3RhdHVzPW5vLG1lbnViYXI9bm8sd2lkdGg9JHtQT1BVUF9XSURUSH0saGVpZ2h0PSR7UE9QVVBfSEVJR0hUfSx0b3A9JHt0b3B9LGxlZnQ9JHtsZWZ0fWBcbiAgICApO1xuXG4gICAgaWYgKHBvcHVwV2luZG93KSB7XG4gICAgICBwb3B1cFdpbmRvdy5mb2N1cygpO1xuICAgICAgY29uc3QgaW50ZXJ2YWxJZCA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgLy8gY2xlYXIgaXRzZWxmIGlmIHdpbmRvdyBubyBsb25nZXIgZXhpc3RzIG9yIGhhcyBiZWVuIGNsb3NlZFxuICAgICAgICBpZiAocG9wdXBXaW5kb3c/LmNsb3NlZCkge1xuICAgICAgICAgIC8vIHdpbmRvdyBjbG9zZWQsIG5vdGlmeSBjb25uZWN0XG4gICAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbElkKTtcbiAgICAgICAgICB0aGlzLnBvc3RNZXNzYWdlKHtcbiAgICAgICAgICAgIHR5cGU6IFdJTkRPV19FVkVOVCxcbiAgICAgICAgICAgIGNsb3NlZDogdHJ1ZSxcbiAgICAgICAgICAgIGJsb2NrZWQ6IGZhbHNlLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9LCAxMDAwKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wb3N0TWVzc2FnZSh7XG4gICAgICAgIHR5cGU6IFdJTkRPV19FVkVOVCxcbiAgICAgICAgY2xvc2VkOiB0cnVlLFxuICAgICAgICBibG9ja2VkOiB0cnVlLFxuICAgICAgfSk7XG4gICAgfVxuICB9LFxuXG4gIHBvc3RNZXNzYWdlKGRhdGE6IGFueSkge1xuICAgIHRhcmdldFdpbmRvdz8ucG9zdE1lc3NhZ2UoZGF0YSwgY29ubmVjdFVybCk7XG4gIH0sXG59O1xuXG4oZnVuY3Rpb24gYXBwbHlTdHlsZXMoKSB7XG4gIGlmICghZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoU1RZTEVTX0lEKSkge1xuICAgIGNvbnN0IHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTtcbiAgICBzdHlsZS5pZCA9IFNUWUxFU19JRDtcbiAgICBzdHlsZS50eXBlID0gJ3RleHQvY3NzJztcbiAgICBzdHlsZS5pbm5lckhUTUwgPSBgIyR7SUZSQU1FX0lEfSB7XG4gICAgICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gICAgICBsZWZ0OiAwO1xuICAgICAgdG9wOiAwO1xuICAgICAgd2lkdGg6IDEwMCU7XG4gICAgICBoZWlnaHQ6IDEwMCU7XG4gICAgICB6LWluZGV4OiAxMDtcbiAgICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC44KTtcbiAgICB9YDtcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdLmFwcGVuZENoaWxkKHN0eWxlKTtcbiAgfVxufSkoKTtcbiJdfQ==